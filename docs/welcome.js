// welcome.js
// First-run welcome / tour overlay for VeloDrive.

const SLIDES = [
  {
    id: "splash",
    kind: "splash", // logo + text only
    title: "Welcome to VeloDrive",
    bodyLines: [
      "Indoor bike workouts that run directly in your browser.",
      "Tap or press \u2192 to continue.",
    ],
  },
  {
    id: "trainers",
    kind: "scene",
    title: "Ride structured workouts on your smart trainer",
    bodyLines: [
      "Control Bluetooth-FTMS trainers like Wahoo KICKR, Tacx Neo.",
      "See live power, heart rate, cadence, and time.",
    ],
  },
  {
    id: "offline",
    kind: "scene",
    title: "Local data. Offline workouts.",
    bodyLines: [
      "Install VeloDrive as a Progressive Web App so it runs like a native application.",
      "Workouts and history are stored on your filesystem, so you can ride with no internet connection.",
    ],
  },
  {
    id: "workouts",
    kind: "scene",
    title: "Use community workouts or build your own",
    bodyLines: [
      "Import workouts from TrainerRoad, TrainerDay, and Zwift collections.",
      "Export them as .zwo or .fit files, or build your own sessions from scratch.",
    ],
  },
];

const INLINE_ICONS = {
  wahoo: {
    viewBox: "0 0 541.76318 538.43848",
    path: "M 22.5,537.08716 C 8.198116,533.39702 0,524.05205 0,511.43958 c 0,-3.33595 0.673349,-7.67692 1.496331,-9.64659 2.083765,-4.98715 34.657553,-45.46718 38.298019,-47.59363 1.637522,-0.95651 6.375886,-2.24457 10.5297,-2.86238 7.37821,-1.09737 7.65182,-1.24154 11.86417,-6.25147 3.38293,-4.02347 29.62129,-33.19054 65.1857,-72.4617 l 2.09617,-2.31465 -2.23505,-3.88347 C 126.00577,364.28978 125,362.15262 125,361.67644 c 0,-0.47617 1.99287,-3.83725 4.4286,-7.46907 l 4.4286,-6.6033 -3.41967,-6.44003 c -14.02559,-26.41342 -16.72447,-62.31749 -6.76804,-90.03758 10.41531,-28.99771 29.13457,-50.59439 54.83051,-63.25876 16.56553,-8.16441 27.32006,-10.66479 46.5,-10.81105 8.525,-0.065 17.58241,0.20314 20.12758,0.59589 l 4.62758,0.71409 3.2089,-10.21409 c 4.32789,-13.77587 4.77708,-14.36578 12.02455,-15.79163 L 271,151.17824 v -14.7389 c 0,-23.96061 4.36549,-42.820122 14.53624,-62.798622 C 304.58357,36.225898 339.96967,9.9049685 382,1.8889185 c 12.97587,-2.47476004 37.20175,-2.52618004 49.374,-0.10479 28.93167,5.75529 52.20861,18.2241095 71.87284,38.5003195 22.3386,23.03381 34.30799,49.18574 37.82962,82.654002 4.03566,38.35345 -9.91075,79.53739 -36.69886,108.3722 -18.52568,19.94111 -46.65341,35.50974 -72.74758,40.26561 -6.09942,1.11167 -6.97762,1.56087 -7.82959,4.00484 -1.16618,3.34531 -2.00225,3.66889 -31.80043,12.30751 -12.375,3.58757 -30.32886,8.89158 -39.89747,11.78668 l -17.39748,5.26382 -1.86844,6.8207 c -1.02764,3.75139 -2.72925,8.50803 -3.78135,10.57031 l -1.9129,3.74961 40.17882,38.04781 c 22.09835,20.9263 55.44852,52.50701 74.11148,70.17936 l 33.93266,32.13155 h 15.73675 15.73676 l 5.61644,5.13311 c 3.08904,2.82321 6.80029,7.15321 8.24722,9.62221 2.95052,5.03468 6.27785,17.63214 6.28971,23.81318 0.0187,9.769 -5.542,19.3201 -12.20372,20.96107 -2.45926,0.60579 -2.77362,1.21691 -3.37916,6.56918 l -0.66765,5.90125 h -17.49103 -17.49102 l 0.434,-6 0.434,-6 h -4.86347 c -7.68068,0 -13.09571,-3.76262 -16.23785,-11.28281 l -1.56915,-3.75552 -178.18174,0.685 -178.18174,0.685 -13.97317,10.89442 c -7.68524,5.99193 -15.58131,11.61239 -17.54683,12.48991 -4.82819,2.15558 -36.229132,2.82773 -43.57367,0.93271 z m 401.40253,-61.64871 c -0.0526,-0.275 -4.46113,-4.55 -9.79681,-9.5 -5.33568,-4.95 -30.98091,-29.25 -56.9894,-54 -26.00849,-24.75 -48.82907,-46.28482 -50.71241,-47.85515 l -3.42424,-2.85515 -6.33254,5.92379 c -26.50481,24.79395 -65.88669,35.08608 -102.42915,26.76902 l -7.28202,-1.65738 -3.97086,3.58743 c -2.18397,1.97309 -4.83968,3.58744 -5.90156,3.58744 -1.36284,0 -2.02376,0.80883 -2.24712,2.75 -0.27816,2.41747 -0.8001,2.79265 -4.31642,3.10273 -3.82508,0.3373 -5.01785,1.47066 -27.27547,25.91681 l -23.27548,25.56408 3.38705,2.79189 c 4.25559,3.50782 5.99279,7.62855 5.48053,13.00012 l -0.39954,4.18954 147.7905,-0.40758 c 81.28478,-0.22418 147.7475,-0.63259 147.69494,-0.90759 z m 3.03521,-239.57351 c 4.09075,-0.77108 7.75268,-1.74498 8.1376,-2.16423 2.38071,-2.59295 1.35636,-5.79884 -8.3914,-26.26226 -10.17604,-21.36252 -10.26052,-21.49778 -13.21273,-21.15275 -1.63417,0.19099 -3.16693,0.53671 -3.40615,0.76827 -0.33207,0.32144 -6.81981,44.25772 -7.02329,47.56305 -0.023,0.37322 0.70962,1.42996 1.62798,2.34832 1.86383,1.86383 8.20434,1.55051 22.26799,-1.1004 z m -37.02283,-0.82396 c 1.07552,-1.29593 2.98493,-28.88622 3.05663,-44.16732 0.0278,-5.91595 -0.0545,-6.10434 -3.35121,-7.67644 l -3.37967,-1.61165 -14.22585,19.47195 c -7.82422,10.70958 -14.45648,20.35387 -14.73836,21.43177 -1.00739,3.85229 2.36854,5.94852 17.72355,11.00514 9.6565,3.18002 13.25,3.55264 14.91491,1.54655 z m 70.72521,-12.44832 c 7.26622,-4.69639 19.80471,-15.37728 22.01921,-18.75703 1.25741,-1.91906 1.38517,-3.00409 0.56555,-4.80297 -0.6287,-1.37983 -9.00741,-7.45977 -20.62534,-14.96658 l -19.56651,-12.64271 -5.44268,4.21124 c -4.05786,3.13973 -5.23861,4.60467 -4.6406,5.75754 0.44115,0.85046 4.0849,10.9963 8.09723,22.5463 4.01232,11.55 7.78066,21.33061 8.37408,21.73469 2.24198,1.52664 5.45657,0.64399 11.21906,-3.08048 z m -113.86679,-8.40421 c 0.56002,-0.6875 6.38544,-10.52549 12.94538,-21.86221 l 11.92716,-20.6122 -3.68314,-4.3193 -3.68315,-4.3193 -21.38979,7.92762 c -21.61702,8.01184 -26.69519,10.8533 -25.43118,14.22986 1.64884,4.40455 7.7408,13.15001 14.82084,21.27638 6.3843,7.32783 8.29021,8.92915 10.62755,8.92915 1.56646,0 3.30631,-0.5625 3.86633,-1.25 z m 150.91052,-34.75 c 3.29511,-6.72716 7.55934,-20.34056 8.68914,-27.73981 0.53848,-3.52659 0.28698,-4.60022 -1.49506,-6.38226 -1.9106,-1.9106 -2.85855,-2.07479 -8.76018,-1.51729 -3.63976,0.34383 -14.29509,0.62834 -23.6785,0.63225 l -17.06075,0.007 -1.81079,6.04512 c -0.99594,3.32482 -1.64361,6.17871 -1.43926,6.34199 43.76816,34.97148 40.3363,33.26797 45.5554,22.61289 z M 336.09481,157.30428 c 11.77286,-6.1238 21.5291,-11.23521 21.68054,-11.35868 0.15144,-0.12348 -0.0134,-2.6506 -0.36636,-5.61583 l -0.64169,-5.39132 -14.63365,-3.72479 c -8.04851,-2.04864 -18.47812,-4.79299 -23.17691,-6.09856 -11.49978,-3.19523 -12.57763,-2.73025 -13.49339,5.82097 -0.81506,7.61096 -0.006,17.92033 2.19746,28.00238 1.4429,6.60194 3.23516,9.5 5.87513,9.5 0.63453,0 10.78602,-5.01038 22.55887,-11.13417 z m 78.33947,-4.85099 c 5.69085,-2.77867 8.79649,-7.70559 8.79649,-13.95516 0,-9.35742 -6.43877,-16.05968 -15.42831,-16.05968 -6.02044,0 -9.84913,1.88357 -13.46505,6.62428 -5.72014,7.49949 -2.61016,19.53104 6.06713,23.47184 5.28507,2.40022 8.99147,2.37874 14.02974,-0.0813 z m -12.52094,-6.29664 c -4.44167,-3.41021 -5.1456,-10.17409 -1.49992,-14.41244 2.004,-2.32979 3.20617,-2.80576 7.08658,-2.80576 3.88041,0 5.08258,0.47597 7.08658,2.80576 3.25379,3.78275 3.18648,8.62206 -0.17547,12.61751 -2.13984,2.54305 -3.31067,3.07121 -6.75,3.04493 -2.28861,-0.0175 -4.87511,-0.58 -5.74777,-1.25 z m 103.25902,-15.81044 c 1.86132,-0.99615 1.97821,-1.67799 1.32862,-7.75 -0.84055,-7.85692 -4.6205,-21.48015 -8.05135,-29.017752 -2.31463,-5.08523 -2.60654,-5.33891 -5.69466,-4.9488 -2.12864,0.26889 -9.85001,4.99778 -22.31399,13.666002 l -19.05902,13.25483 1.94218,5.92365 c 2.29241,6.99185 0.34386,6.38135 25.67586,8.04451 9.625,0.63193 17.6875,1.3224 17.91667,1.53438 0.86987,0.80464 6.30021,0.33972 8.25569,-0.70682 z M 362.519,113.40096 c 1.40398,-2.77062 2.2193,-5.58312 1.81181,-6.25 -2.40592,-3.93751 -30.76221,-34.714662 -32.48904,-35.262732 -2.78806,-0.8849 -5.51063,1.96817 -11.64767,12.20597 -9.99749,16.677812 -12.28737,25.553782 -6.92887,26.857512 3.07429,0.74798 42.82166,7.28646 44.96792,7.39726 1.12001,0.0578 2.63624,-1.69266 4.28585,-4.94801 z m 99.70033,-23.364222 c 11.15437,-6.27094 21.06817,-12.12094 22.03067,-13 3.36528,-3.07354 2.15873,-5.95578 -5.56412,-13.29172 -7.83073,-7.43843 -21.98195,-17.30657 -24.81815,-17.30657 -0.94868,0 -2.31952,0.59556 -3.0463,1.32347 -0.72679,0.72791 -5.09517,11.35039 -9.70753,23.60552 l -8.38609,22.28204 4.38609,3.85185 c 2.41236,2.11851 4.4848,3.871032 4.60543,3.894482 0.12064,0.0235 9.34564,-5.088132 20.5,-11.359072 z m -79.35999,2.78484 c 4.45403,-2.31084 4.98798,-2.92482 4.5657,-5.25 -0.26302,-1.44822 -1.76986,-12.20613 -3.34855,-23.90647 -1.57868,-11.70033 -3.42182,-21.93783 -4.09586,-22.75 -0.67403,-0.81216 -2.35585,-1.47666 -3.73737,-1.47666 -3.52969,0 -20.22999,8.10139 -27.72415,13.44911 -6.43599,4.59263 -8.09001,6.78313 -6.7707,8.96678 0.41337,0.68421 7.27659,7.33833 15.25159,14.78694 7.975,7.4486 15.59094,14.72513 16.92431,16.17005 1.33338,1.44491 2.75435,2.62712 3.15772,2.62712 0.40337,0 3.00316,-1.17759 5.77731,-2.61687 z m 44.6129,-27.03766 c 5.79027,-11.90999 10.52087,-22.37249 10.51245,-23.25 -0.0303,-3.15844 -1.86179,-4.34157 -9.6104,-6.20829 -8.64127,-2.08177 -26.58315,-3.55354 -30.70589,-2.5188 -5.31985,1.3352 -5.26936,2.87474 0.93965,28.65089 l 5.75247,23.8809 3.06974,0.38988 c 1.68836,0.21443 4.51975,0.46189 6.29198,0.54991 l 3.22223,0.16004 z",
  },
  tacx: {
    viewBox: "0 0 685.40222 509.5123",
    path: "m 556,508.68377 -35,-0.54298 -15,-5.65956 c -8.25,-3.11276 -23.55,-8.93451 -34,-12.93722 -17.7336,-6.79257 -19.4999,-7.27213 -26.5,-7.19467 -4.125,0.0457 -38.1,1.92227 -75.5,4.17026 -37.4,2.24799 -80.375,4.79012 -95.5,5.64919 -63.80522,3.624 -77.22594,4.98981 -107.90141,10.98103 L 138.19717,508.6969 75.02016,508.42534 11.84315,508.15378 8.2413,505.40607 C 1.56919,500.31618 0,497.09569 0,488.49227 c 0,-7.62295 0.0261,-7.69843 5.19286,-15 2.85608,-4.03617 13.65608,-19.71349 24,-34.83849 C 42.27795,419.52063 50.28187,408.85517 55.5,403.59874 61.81499,397.2374 156.66942,320.7071 206.6786,281.62506 c 13.84141,-10.81703 14.68179,-11.6709 14.73468,-14.97128 0.0659,-4.1095 -0.3094,-4.72358 -4.82943,-7.90278 -6.67762,-4.69675 -56.11533,-47.32609 -59.99164,-51.72981 -4.69076,-5.32898 -7.09221,-11.77113 -7.09221,-19.02565 0,-3.36218 2.17174,-13.2667 5.93598,-27.07186 5.19579,-19.05533 26.4471,-97.897968 32.20914,-119.496338 1.58167,-5.92872 2.99628,-8.78868 6.07986,-12.29181 7.21821,-8.20033 6.73509,-8.0834 64.27502,-15.55646 28.6,-3.7144596 64.6,-8.4049896 80,-10.4233996 16.3381,-2.14135 29.7714,-3.43439003 32.2532,-3.10455003 7.1841,0.95481003 11.9103,4.22503003 26.6292,18.42553963 7.7971,7.52242 24.5132,23.43573 37.147,35.36292 24.2093,22.85522 27.2319,26.08085 34.9659,37.3142 4.9333,7.16555 6.8697,11.031718 22.0376,43.999998 4.8078,10.45 15.7023,33.4 24.21,51 8.5077,17.6 25.5058,53.15 37.7736,79 12.2678,25.85 25.5686,53.75 29.5575,62 6.964,14.40366 7.2553,15.29817 7.3256,22.5 0.083,8.47268 -0.9375,11.04397 -7.9937,20.1474 -5.3537,6.90702 -6.0819,8.74581 -6.92,17.47549 l -0.6603,6.87711 37.2846,32 c 64.0584,54.97891 70.3435,60.54191 72.0979,63.81409 3.4399,6.41614 1.4948,14.0671 -4.5066,17.72639 -3.0579,1.86448 -5.1078,1.94263 -45.7015,1.74227 -23.375,-0.11538 -58.25,-0.45412 -77.5,-0.75276 z M 314.5,439.1384 c 56.925,-4.68428 105.2785,-9.00492 107.4521,-9.60144 3.9384,-1.08079 7.1037,-4.14236 40.8029,-39.46451 l 6.7559,-7.08133 -17.2554,-6.59757 c -94.8871,-36.27977 -173.4113,-65.87238 -178.576,-67.29812 -5.886,-1.62482 -6.5569,-1.63212 -9.7569,-0.10613 -4.7299,2.25553 -7.4142,7.0019 -7.4189,13.11779 0,4.83536 -0.8015,6.15209 -33.5037,55.29103 -30.05715,45.16442 -33.5,50.74968 -33.5,54.34634 0,8.95497 7.41214,15.8892 17,15.9039 2.475,0.004 51.075,-3.82569 108,-8.50996 z m 202.469,-23.15716 c 5.7921,-6.86527 10.531,-12.89748 10.531,-13.40489 0,-2.78469 -3.762,0.41605 -14.3609,12.21839 -8.1391,9.06329 -11.4161,13.37882 -10.5607,13.90748 2.1608,1.33548 3.6194,0.0461 14.3906,-12.72098 z m -21.1089,8.42254 c 5.0337,-4.58237 19.6399,-23.09334 19.6399,-24.89034 0,-3.56531 -2.6568,-1.79763 -11.1076,7.39034 -16.4262,17.85898 -16.395,17.8194 -14.8278,18.81109 2.2319,1.41229 3.6218,1.12282 6.2955,-1.31109 z m -3.3973,-13.20904 c 11.4631,-12.61607 12.4608,-13.99468 11.6523,-16.1017 -0.9893,-2.57801 -4.3883,-1.52152 -7.7872,2.42043 -1.8303,2.12282 -7.3036,8.17904 -12.1627,13.45824 -4.8592,5.27921 -8.5451,10.06735 -8.191,10.64032 0.3541,0.57296 1.8662,1.04175 3.3603,1.04175 2.1914,0 4.7286,-2.21452 13.1283,-11.45904 z M 224.13856,324.24666 c 10.55179,-10.20595 13.58794,-13.69083 12.71614,-14.59534 -0.87451,-0.90721 -3.59411,1.10859 -11.50003,8.52394 -5.69507,5.34168 -12.49217,11.27679 -15.10467,13.18914 -4.91271,3.59609 -5.6391,4.76395 -3.5,5.6271 2.75325,1.11096 4.03299,0.17298 17.38856,-12.74484 z m -13.27228,-4.27168 C 218.63983,312.45165 225,305.82031 225,305.23868 c 0,-3.27653 -4.59513,-0.21761 -18.01527,11.99252 -8.2416,7.49851 -15.1967,13.83563 -15.45577,14.08249 -0.6433,0.61297 2.15104,2.30588 3.83732,2.32478 0.75146,0.008 7.72646,-6.14015 15.5,-13.66349 z M 361.6664,242.11065 c 13.8146,-3.5797 29.01,-13.62914 37.4287,-24.75329 9.778,-12.92031 14.3708,-26.8878 14.3704,-43.70358 -3e-4,-13.83855 -1.924,-22.46634 -7.5809,-34 -8.6893,-17.7164 -25.6722,-31.45946 -45.3846,-36.72657 -10.1522,-2.71264 -27.3457,-2.27477 -37.1667,0.94654 -11.8123,3.87449 -20.418,9.16003 -28.8333,17.70918 -13.2433,13.45397 -19.7267,28.03508 -20.7259,46.61174 -1.9643,36.52368 20.9353,66.938 56.3926,74.89839 8.1676,1.83368 22.3376,1.39175 31.4997,-0.98241 z m -27.434,-51.47902 c -11.8383,-6.4215 -13.9822,-22.24094 -4.2789,-31.57281 13.4977,-12.9809 34.7044,-3.09 33.3556,15.55717 -0.4843,6.69606 -3.1407,11.35588 -8.6095,15.10322 -4.8882,3.34939 -15.1326,3.80608 -20.4672,0.91242 z",
  },
  bike: {
    viewBox: "0 0 911.82745 817.78851",
    path: "m 663.84391,815.43423 c -13.68335,-2.37606 -20.6039,-4.50006 -22.04355,-6.76543 -1.42761,-2.24641 -0.81404,-6.95245 1.38113,-10.59318 10.76978,-17.86189 26.70151,-41.68417 30.35708,-45.39211 4.47244,-4.53652 4.60765,-4.59094 21.73094,-8.74635 9.47677,-2.29979 25.33049,-5.85597 35.23049,-7.90262 l 18,-3.72119 3.83597,-5.42788 c 12.63434,-17.87752 15.13382,-31.89953 9.7049,-54.44408 -2.38338,-9.8974 -15.48685,-54.70247 -29.53323,-100.9838 -5.84237,-19.25 -14.23378,-47.375 -18.64759,-62.5 -4.4138,-15.125 -10.88678,-36.5 -14.3844,-47.5 -10.24337,-32.2154 -25.99986,-84.01894 -29.50339,-97 -2.16847,-8.03448 -3.44256,-15.44969 -3.8555,-22.43906 L 665.5,331.57947 654,344.5164 c -6.325,7.11531 -14.38401,16.08788 -17.90891,19.93906 -3.5249,3.85117 -12.35978,14.65213 -19.63307,24.00213 -7.27329,9.35 -18.96508,23.75 -25.98176,32 -18.53474,21.79259 -43.69718,51.93115 -70.96585,85 -32.04957,38.86669 -39.50588,47.46134 -55.98349,64.53038 -10.46928,10.84504 -15.26944,16.67853 -18.92588,23 -2.69442,4.65829 -6.40368,10.92536 -8.2428,13.92682 -1.83911,3.00146 -3.00958,5.77766 -2.60104,6.16933 2.88909,2.76978 25.52297,10.41951 39.70914,13.42077 6.44533,1.36359 8.59329,2.31233 11.25,4.96904 2.76993,2.76993 3.28366,4.01111 3.28366,7.93332 0,2.55731 -0.65884,5.92371 -1.46408,7.48088 -2.03864,3.9423 -7.21727,8.06946 -10.1253,8.06946 -1.33977,0 -5.6837,0.9 -9.65318,2 -16.32249,4.52319 -35.11582,0.56392 -47.92633,-10.09686 l -4.66889,-3.88541 -3.61683,6.46749 c -4.39047,7.8509 -7.42722,10.25973 -18.90588,14.99665 -35.35204,14.58878 -59.73685,9.98288 -79.62092,-15.03914 -3.27072,-4.11585 -7.53775,-10.83606 -9.4823,-14.9338 -3.85765,-8.12923 -8.18744,-23.60249 -9.20521,-32.89646 l -0.64474,-5.88753 -7.09317,-3.27431 c -3.90124,-1.80088 -9.47004,-4.17622 -12.37511,-5.27854 l -5.28195,-2.00422 -1.35666,2.16607 c -6.28238,10.03053 -33.70627,55.04293 -35.50062,58.26921 -1.25512,2.25673 -2.12382,4.88167 -1.93044,5.83319 0.75123,3.69633 28.73339,11.36031 76.85161,21.04874 48.8199,9.82971 48.75336,9.81401 50.95839,12.02419 2.10104,2.10594 11.04161,28.85905 11.04161,33.0401 0,1.39752 -0.9423,3.01145 -2.25,3.85374 -3.37252,2.17224 -16.67201,4.59689 -25.21442,4.59689 -9.64623,0 -27.72223,-2.69441 -28.73147,-4.28271 -0.42541,-0.66951 -0.78038,-2.69391 -0.7888,-4.49867 -0.008,-1.80477 -0.57781,-3.47631 -1.26531,-3.71455 -2.24777,-0.7789 -59.8765,-8.44685 -75.42586,-10.03599 -14.38711,-1.47036 -16.20617,-1.44611 -35,0.46662 -10.90327,1.10967 -37.59914,3.81781 -59.32414,6.01808 -21.725,2.20027 -45.575,4.68168 -53,5.51423 -7.425,0.83256 -14.2602,1.51807 -15.18933,1.52336 -1.34106,0.008 -1.65029,0.85666 -1.5,4.11826 0.27187,5.89988 -2.31751,7.50438 -15.31067,9.4872 -12.518662,1.9104 -26.916935,1.37141 -40.83208,-1.52854 C 1.522843,726.38961 0,725.29109 0,718.80471 c 0,-4.5551 0.8497,-6.57816 7.865453,-18.72695 9.51949,-16.48437 32.314185,-59.77514 70.620797,-134.12017 9.21017,-17.875 18.21637,-35.2 20.01378,-38.5 1.7974,-3.3 4.42661,-8.25 5.84268,-11 l 2.57467,-5 -2.94887,-8.29473 c -10.75978,-30.26563 -8.8238,-65.68335 5.10375,-93.37059 14.61487,-29.0536 38.24865,-48.72461 65.19394,-54.26262 24.1497,-4.96343 44.71788,-2.21526 62.64363,8.36999 3.42755,2.02399 6.17572,2.99229 7.5,2.6426 1.14959,-0.30356 7.38394,-5.62179 13.85411,-11.81829 l 11.76394,-11.26636 -0.0152,-5.5 c -0.0179,-6.44801 -2.76576,-18.13772 -10.57817,-45 -5.09967,-17.53476 -5.69406,-20.55821 -5.89788,-30 -0.19504,-9.03577 -1.47546,-13.45521 -5.85199,-32.5 -8.91898,-38.81158 -7.15121,-43.13304 -15.99064,-72.47289 -1.0837,-3.1532 -1.88381,-3.70548 -8.69244,-6 -8.98438,-3.02774 -11.02471,-5.6703 -8.67172,-11.23127 0.76701,-1.81272 2.40275,-4.1948 3.63496,-5.2935 1.23222,-1.0987 2.86932,-3.21384 3.63801,-4.70032 2.45014,-4.73806 -0.40778,-4.95507 -11.93693,-0.90641 -9.55404,3.35506 -10.91831,3.57081 -22.68313,3.58707 -12.10543,0.0167 -12.7342,-0.0892 -19.09204,-3.2176 -12.57791,-6.18894 -22.5483,-19.4022 -23.62838,-31.313533 -1.33144,-14.6834 8.67944,-24.13353 28.61234,-27.00966 9.78229,-1.41149 16.80599,-1.0247 46.62577,2.56766 17.2189,2.07435 28.1937,2.75506 50.5,3.13227 30.45695,0.51504 37.11132,1.35393 45.84455,5.77939 6.40334,3.24481 13.88887,10.95695 15.34172,15.80616 1.9479,6.501503 0.0526,7.522783 -19.3117,10.405873 -9.00601,1.34088 -17.85352,2.67042 -19.66113,2.95452 -2.23897,0.35191 -5.42646,2.51838 -10,6.79679 -3.69239,3.45413 -9.30094,7.81079 -12.46344,9.68146 -3.1625,1.87068 -5.75,3.68541 -5.75,4.03274 0,0.34733 0.83594,1.7047 1.85764,3.01637 1.02171,1.31167 2.463,4.07481 3.20286,6.14031 1.34289,3.74896 1.33775,3.76306 -2.97869,8.16119 l -4.3239,4.40574 1.22972,5.12606 c 5.84286,24.35583 17.34306,62.26899 26.06566,89.15113 0.3365,1.03707 3.30044,2.90008 6.19105,4.30844 l 5.25566,2.56065 31,-5.96441 c 29.64775,-5.70423 163.36637,-32.92097 199,-40.50394 9.35,-1.98971 32.075,-6.72507 50.5,-10.52302 18.425,-3.79794 38.62599,-8.38684 44.89109,-10.19754 l 11.3911,-3.2922 0.15422,-5.99377 c 0.0988,-3.842 0.83103,-7.13926 2.03949,-9.1845 l 1.88528,-3.19072 -5.84836,-25.80928 c -3.2166,-14.1951 -6.37549,-28.05928 -7.01975,-30.80928 -1.37155,-5.85442 -0.19735,-5.66178 -18.24021,-2.99239 -14.5995,2.15996 -20.7379,1.30211 -27.43784,-3.83448 -9.68847,-7.427793 -10.92208,-20.648443 -2.64758,-28.374283 7.89503,-7.37154 25.10764,-10.08196 83.83256,-13.20089 15.13332,-0.80375 15.74225,-0.92393 25.74037,-5.08044 5.63221,-2.34147 13.50721,-6.29194 17.5,-8.77883 21.86259,-13.61696 64.20466,-38.8211204 70.25963,-41.8221004 17.50787,-8.677326 32.2152,-8.485926 39.79137,0.51784 2.05593,2.44333 2.70863,4.2902904 2.70863,7.6646404 0,7.59216 -3.3272,10.42737 -46.82499,39.90093 -6.49363,4.4 -13.34635,8.8279 -15.22827,9.83978 -3.1747,1.70698 -3.29116,1.93521 -1.61345,3.16198 0.99452,0.72721 6.16388,1.65616 11.48747,2.06434 18.28251,1.40179 37.93751,-2.7664 50.25765,-10.65803 3.84766,-2.46461 13.83685,-11.5622 24.92159,-22.69716 21.90763,-22.0069 25.17667,-24.65943 32.37666,-26.2707204 4.92645,-1.10249 5.8268,-1.02011 9.7832,0.8951504 2.70867,1.31124 5.4226,3.72796 7.17252,6.38703 5.84064,8.87507 2.24702,17.80921 -14.94439,37.15337 -16.40767,18.46228 -19.41985,22.24107 -21.01126,26.35868 -1.50201,3.88633 -1.50791,4.95497 -0.0717,13 2.09187,11.717623 2.52561,16.315013 3.74172,39.660163 1.10929,21.29474 2.108,27.94738 5.07644,33.81558 2.29199,4.53096 2.35613,6.96222 0.2891,10.95941 -1.47456,2.85149 -1.88424,3.03161 -5.75,2.52795 -3.43283,-0.44725 -5.01584,-1.476 -9.03243,-5.86991 -6.1582,-6.73668 -10.86702,-13.9605 -13.26062,-20.34314 -1.66158,-4.43067 -1.83977,-7.56016 -1.60388,-28.16699 0.26344,-23.01272 0.24899,-23.19401 -1.9725,-24.75 -3.00713,-2.106283 -11.40402,-2.008413 -15.79288,0.18407 l -3.5,1.74845 -0.0647,18.5 c -0.0737,21.05922 -0.98344,25.6354 -7.52506,37.85125 -9.96395,18.60672 -24.58984,31.1043 -46.44968,39.69049 -11.84678,4.65321 -17.86449,5.90094 -28.60555,5.93114 -8.26123,0.0232 -9.96171,-0.25948 -11.85238,-1.97052 C 716.56122,200.34554 715,196.49161 715,191.11084 c 0,-7.37853 3.38405,-9.92984 18.59379,-14.01826 26.74526,-7.18921 33.80774,-10.67026 41.64662,-20.52734 9.46185,-11.89791 12.85877,-24.10879 10.9378,-39.31803 C 784.164,101.2997 783.26277,100.33241 768,97.736497 c -9.34528,-1.58946 -91.85722,-1.70619 -96.5,-0.13652 -2.79521,0.94503 -2.99824,1.35024 -2.9742,5.935943 0.0142,2.70692 2.39639,15.27167 5.29378,27.92167 7.49517,32.72391 6.62133,30.17253 10.58897,30.91687 1.86477,0.34983 3.82842,1.18665 4.36368,1.85959 0.93367,1.17385 9.2475,32.42695 14.63841,55.02831 3.7352,15.65977 18.46068,69.14302 20.15076,73.18795 0.79123,1.89367 1.4386,4.74179 1.4386,6.32914 0,3.56931 2.46304,6.28767 12.26541,13.53686 4.18608,3.09576 9.03642,7.32641 10.77852,9.40146 7.23727,8.6204 20.56118,36.56645 28.85223,60.5157 2.13714,6.17327 8.24438,22.92412 13.57164,37.22412 20.64128,55.40752 54.4016,149.91202 68.05327,190.5 7.86213,23.375 22.69114,67.025 32.95336,97 10.26221,29.975 19.1488,56.83442 19.74797,59.6876 0.91617,4.36272 0.83211,5.58027 -0.52866,7.65706 -4.52207,6.90156 -27.58277,8.27187 -56.1009,3.33363 -8.74893,-1.51498 -16.28643,-2.98892 -16.75,-3.27542 -1.30831,-0.80858 -0.99256,-5.40966 0.40716,-5.93302 0.6875,-0.25706 5.27549,-1.29441 10.19553,-2.30521 9.09269,-1.86806 10.23123,-2.54255 8.61305,-5.10258 -0.76462,-1.20965 -4.37382,-0.53629 -22.73375,4.24135 -29.33073,7.63247 -54.80384,13.73683 -84.69332,20.29585 -13.67766,3.00146 -25.71651,5.91105 -26.753,6.46576 -1.70013,0.90988 -1.82161,1.82704 -1.24153,9.3737 l 0.643,8.36514 -2.88999,1.49302 c -1.58949,0.82117 -8.11917,2.6653 -14.5104,4.09807 -14.38915,3.22574 -22.83283,3.24255 -41.03568,0.0817 z M 834.6678,719.37835 c 8.83408,-1.51865 9.26508,-1.7164 11.8405,-5.43274 5.10432,-7.36553 5.54614,-13.75974 2.02373,-29.28795 -2.67122,-11.77577 -20.33241,-72.78572 -21.38338,-73.86812 -0.35676,-0.36742 -10.87861,1.38426 -23.3819,3.89263 l -22.73326,4.56068 0.62072,2.60737 c 0.3414,1.43405 4.43206,15.65737 9.09036,31.60737 4.65831,15.95 10.67546,36.65 13.37146,46 2.696,9.35 5.62963,18.37799 6.51917,20.06221 l 1.61734,3.06221 6.62373,-0.81382 c 3.64305,-0.4476 10.74924,-1.52303 15.79153,-2.38984 z M 129.5,661.88748 c 25.81632,-2.27343 28.22485,-2.926 32.39024,-8.77575 1.05931,-1.48766 9.6686,-15.51844 19.13176,-31.17949 l 17.20573,-28.47465 -4.36386,-0.85273 c -10.50594,-2.05294 -19.65816,-4.99081 -30.07552,-9.65428 -6.14766,-2.75208 -11.50672,-4.66385 -11.90903,-4.24839 -1.24283,1.28347 -37.73978,57.06761 -45.52347,69.58081 C 102.31013,654.78697 99,661.21987 99,662.57831 c 0,2.2273 0.31923,2.41847 3.25,1.94628 1.7875,-0.28799 14.05,-1.47469 27.25,-2.63711 z m 671.20027,-76.64981 17.20027,-3.78008 -7.89052,-20.2257 c -9.28794,-23.80772 -16.61015,-40.86823 -29.45651,-68.63273 -12.87776,-27.83239 -23.88149,-53.56991 -32.55328,-76.14157 -8.70942,-22.66958 -22.22267,-52.89159 -27.99109,-62.60128 -4.15752,-6.99815 -11.54533,-13.76253 -13.21135,-12.09651 -0.46431,0.46431 -0.39835,3.06125 0.14657,5.77099 3.88029,19.29564 6.68342,31.4073 9.58011,41.39346 1.84002,6.34334 6.55372,23.68334 10.47488,38.53334 7.23256,27.39075 22.11527,81.25683 37.04149,134.06697 l 8.21546,29.06696 5.62185,-0.78689 c 3.09202,-0.43279 13.36197,-2.48792 22.82212,-4.56696 z M 430.94964,504.47934 c 9.15877,-11.01196 23.58425,-28.57175 32.05661,-39.02175 28.06396,-34.6147 31.60649,-38.89446 43.45631,-52.5 6.46684,-7.425 20.57647,-24.3 31.35471,-37.5 10.77825,-13.2 34.26275,-41.775 52.18778,-63.5 40.88768,-49.55555 40.71526,-49.33442 42.1164,-54.01104 1.45345,-4.85116 -0.17138,-9.46491 -4.0123,-11.3931 -1.43503,-0.7204 -10.64735,-2.57442 -20.47182,-4.12003 l -17.86267,-2.81022 -11.63733,1.71466 C 548.96228,245.63654 484.856,255.5184 447.5,261.47536 c -22.55,3.59593 -53.825,8.32402 -69.5,10.50687 -39.66039,5.52298 -55.91733,7.96717 -60.0284,9.02511 -2.47302,0.63641 -4.61514,2.3351 -7.1616,5.67912 -6.70813,8.80917 -6.76485,6.72065 1.04139,38.34852 3.85833,15.63244 9.53062,37.64761 12.60511,48.92261 3.07449,11.275 6.51032,25.225 7.63519,31 3.78393,19.42654 4.69584,21.85096 9.05544,24.07506 3.245,1.65547 3.85287,2.46497 3.85287,5.13081 0,1.80685 -0.87315,4.09465 -2.03456,5.33092 l -2.03456,2.16568 6.03257,22.89877 c 3.31791,12.59432 6.03346,23.68626 6.03456,24.64876 10e-4,1.06563 0.76195,1.75 1.94529,1.75 2.55492,0 5.05283,3.68013 5.07201,7.47251 0.008,1.66512 0.3587,3.56769 0.7784,4.22794 0.41969,0.66025 7.7554,3.46444 16.30158,6.23155 12.5001,4.04732 16.89584,5.98432 22.47991,9.90586 3.81777,2.68111 7.53434,5.5892 8.25904,6.46241 2.45435,2.95731 6.09853,-0.31845 23.1154,-20.77852 z M 302.0383,452.68833 c -10.78883,-42.61574 -20.10963,-71.67534 -24.16762,-75.34777 -1.72038,-1.55692 -2.07935,-1.42919 -6.09932,2.17031 -2.34925,2.10353 -4.42064,4.18742 -4.60309,4.63085 -0.18245,0.44344 0.97417,2.11215 2.57026,3.70825 6.91557,6.91557 16.0237,22.44885 20.58579,35.10762 5.66051,15.70665 7.64539,25.90517 8.36886,43 0.31423,7.425 1.01841,14.0643 1.56483,14.754 1.37321,1.73324 7.0206,3.16914 8.21125,2.08778 0.61473,-0.55831 -1.73752,-11.57204 -6.43096,-30.11104 z m -48.66692,-334.7685 c 9.70227,-3.63009 10.44634,-7.51907 0.86649,-4.52882 -6.39501,1.99613 -8.23787,3.15694 -8.23787,5.18902 0,1.83079 0.93819,1.74676 7.37138,-0.6602 z",
  },
  heart: {
    viewBox: "0 0 638.87262 388.89035",
    path: "m 357,387.72687 c -3.12507,-1.24247 -7.76337,-5.58517 -9.48757,-8.88293 -1.23418,-2.36053 -11.28336,-34.46986 -71.66343,-228.98047 -13.74116,-44.26627 -25.13409,-80.634289 -25.31762,-80.817819 -0.42364,-0.42364 -1.07597,1.292 -32.61622,85.781259 -25.50809,68.33043 -26.44122,70.60657 -30.6051,74.6534 -7.91349,7.69103 -3.79724,7.36729 -93.67247,7.36729 -79.18438,0 -80.05061,-0.0215 -84.336,-2.09605 C 3.36371,231.87707 0,226.05707 0,218.65763 0,212.30383 2.44943,207.80914 7.92168,204.1214 l 3.37409,-2.2738 h 74.16098 c 57.76437,0 74.53316,-0.27637 75.84428,-1.25 1.29679,-0.96299 50.94517,-131.612969 69.23848,-182.201439 1.58143,-4.37329 4.24063,-9.5064299 5.90933,-11.4069799 7.70283,-8.77303 20.44222,-9.36327 28.89044,-1.33853 4.19543,3.98513 4.69417,5.2438499 14.14604,35.7015799 27.33276,88.077229 86.80564,278.131659 87.27661,278.905419 0.30466,0.50053 4.99345,-10.29947 10.41953,-24 12.6698,-31.99054 51.77111,-131.16672 59.79878,-151.67307 6.67689,-17.05582 9.25581,-21.03079 15.47839,-23.85732 5.68558,-2.5826 11.1947,-2.35505 17.35953,0.71701 6.61231,3.29506 6.91445,3.81681 24.17571,41.74775 7.60448,16.71056 14.77593,32.2442 15.93656,34.5192 l 2.11022,4.13638 h 57.52933 c 63.70719,0 60.82017,-0.28825 66.07159,6.59672 2.07338,2.71834 2.84873,5.0335 3.16912,9.46282 0.56036,7.74692 -2.69639,13.73853 -9.17135,16.87301 -4.35382,2.10765 -4.8998,2.12241 -68.26413,1.84604 -63.77483,-0.27815 -63.88172,-0.28207 -68.01776,-2.4941 -6.79268,-3.63284 -10.35019,-9.04103 -20.83855,-31.67909 -5.4896,-11.84876 -10.28363,-21.2197 -10.65339,-20.8243 -0.36976,0.39539 -11.03839,26.5939 -23.70805,58.2189 -57.87573,144.46473 -55.69409,139.1412 -58.46538,142.66433 -4.29909,5.46541 -15.55556,8.05229 -22.69208,5.21494 z",
  },
};

function createSvgEl(tag) {
  return document.createElementNS("http://www.w3.org/2000/svg", tag);
}

const svgGroupCache = new Map();

function loadSvgGroupAsset(src) {
  if (!src) return Promise.resolve(null);
  if (svgGroupCache.has(src)) return svgGroupCache.get(src);

  const promise = fetch(src)
    .then((resp) => {
      if (!resp.ok) {
        throw new Error(`Failed to load SVG: ${resp.status}`);
      }
      return resp.text();
    })
    .then((text) => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, "image/svg+xml");
      const svgEl = doc.querySelector("svg");
      if (!svgEl) throw new Error("SVG root missing");
      const viewBox = svgEl.getAttribute("viewBox") || null;
      const defs = svgEl.querySelector("defs");
      const groups = Array.from(svgEl.children || []).filter(
        (node) => node.tagName && node.tagName.toLowerCase() === "g"
      );

      return {
        viewBox,
        defs: defs ? defs.cloneNode(true) : null,
        groups: groups.map((g) => g.cloneNode(true)),
      };
    })
    .catch((err) => {
      console.warn("[Welcome] Unable to load SVG groups", err);
      return null;
    });

  svgGroupCache.set(src, promise);
  return promise;
}

const SCENE_LAYOUTS = {
  splash: {
    baseWidth: 360,
    baseHeight: 360,
    orb: null,
    pathD: null,
    pills: [],
    pulses: [],
    steady: "none",
    enter: "grow",
    exit: "fade",
    assets: [
      {href: "icons/logo_sq.svg", width: 196, height: 196, delay: 80, center: true},
    ],
  },
  trainers: {
    baseWidth: 360,
    baseHeight: 360,
    orb: {cx: 180, cy: 180, r: 130},
    pathD: null,
    pills: [],
    pulses: [],
    metrics: [],
    enter: "fly",
    exit: "rise",
    assets: [
      {icon: "heart", center: true, width: 220, height: 160, delay: 40, colorVar: "--welcome-heart", className: "scene-heart-icon"},
      {icon: "wahoo", x: 14, y: 108, width: 126, height: 96, delay: 150, colorVar: "--welcome-gear-wahoo", className: "scene-asset--wahoo"},
      {icon: "tacx", x: 220, y: 86, width: 130, height: 98, delay: 170, colorVar: "--welcome-gear-tacx", className: "scene-asset--tacx"},
      {icon: "bike", x: 92, y: 120, width: 176, height: 148, delay: 110, colorVar: "--welcome-gear-bike", className: "scene-bike-icon scene-asset--bike"},
    ],
  },
  offline: {
    baseWidth: 360,
    baseHeight: 360,
    enter: "fly",
    exit: "rise",
    groupAsset: {src: "img/browser.svg"},
  },
  workouts: {
    baseWidth: 360,
    baseHeight: 360,
    enter: "fly",
    exit: "rise",
    groupAsset: {src: "img/browser.svg"},
  },
};

function createSceneFromLayout(layout) {
  const VIEWBOX_SIZE = 360;
  const svg = createSvgEl("svg");
  svg.setAttribute("viewBox", `0 0 ${VIEWBOX_SIZE} ${VIEWBOX_SIZE}`);
  svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
  svg.setAttribute("role", "presentation");
  svg.classList.add("welcome-scene-root");
  const enterType = layout.enter || "fly";
  const steadyType = layout.steady || "float";
  const exitType = layout.exit || "rise";
  svg.classList.add(
    `scene-enter-${enterType}`,
    `scene-steady-${steadyType}`,
    `scene-exit-${exitType}`
  );

  const baseWidth = layout.baseWidth || VIEWBOX_SIZE;
  const baseHeight = layout.baseHeight || VIEWBOX_SIZE;
  const offsetX = Math.max(0, (VIEWBOX_SIZE - baseWidth) / 2);
  const offsetY = Math.max(0, (VIEWBOX_SIZE - baseHeight) / 2);
  const contentGroup = createSvgEl("g");
  contentGroup.setAttribute("transform", `translate(${offsetX} ${offsetY})`);

  let maxDelay = 0;

  const addDelay = (el, delay) => {
    el.classList.add("scene-piece");
    el.style.setProperty("--delay", `${delay || 0}ms`);
    if (delay && delay > maxDelay) {
      maxDelay = delay;
    }
  };

  const applyFlyOffset = (el, origin, options = {}) => {
    if (enterType !== "fly") return;
    const cx = VIEWBOX_SIZE / 2;
    const cy = VIEWBOX_SIZE / 2;
    const tx = origin?.x ?? cx;
    const ty = origin?.y ?? cy;
    let dx = tx - cx;
    let dy = ty - cy;
    let len = Math.hypot(dx, dy);
    if (!len || !Number.isFinite(len)) {
      const angle = Math.random() * Math.PI * 2;
      dx = Math.cos(angle);
      dy = Math.sin(angle);
      len = 1;
    }
    const magnitude = options.magnitude ?? 0;
    const jitter = options.jitter ?? 0;
    const distScale = options.distScale ?? 0.9;
    const dist = len * distScale + magnitude + (jitter ? Math.random() * jitter : 0);
    const offsetX = (dx / len) * dist;
    const offsetY = (dy / len) * dist;
    el.style.setProperty("--fly-x", `${offsetX}px`);
    el.style.setProperty("--fly-y", `${offsetY}px`);
  };

  const createInlineAsset = (asset) => {
    const icon = INLINE_ICONS[asset.icon];
    if (!icon) return null;
    const svg = createSvgEl("svg");
    svg.setAttribute("viewBox", icon.viewBox);
    svg.setAttribute("width", asset.width || 100);
    svg.setAttribute("height", asset.height || 100);
    svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
    svg.setAttribute("aria-hidden", "true");
    svg.classList.add("scene-inline-svg");
    if (asset.className) {
      asset.className.split(" ").forEach((cls) => svg.classList.add(cls));
    }
    const path = createSvgEl("path");
    path.setAttribute("d", icon.path);
    path.setAttribute("fill", "currentColor");
    svg.appendChild(path);
    return svg;
  };

  const setFloatProps = (el, options = {}) => {
    const amp = options.amp ?? 4 + Math.random() * 6;
    const ms = options.ms ?? 2300 + Math.random() * 1100;
    const driftX = options.driftX ?? 0;
    el.style.setProperty("--float-ms", `${ms}ms`);
    el.style.setProperty("--float-amp", `${amp}px`);
    el.style.setProperty("--float-x", `${driftX}px`);
  };

  let readyResolve;
  const ready = new Promise((resolve) => {
    readyResolve = resolve;
  });
  let destroyed = false;

  const markReady = () => {
    if (readyResolve) {
      readyResolve();
      readyResolve = null;
    }
  };

  if (layout.orb) {
    const orb = createSvgEl("circle");
    orb.setAttribute("cx", layout.orb.cx);
    orb.setAttribute("cy", layout.orb.cy);
    orb.setAttribute("r", layout.orb.r);
    orb.classList.add("scene-orb");
    addDelay(orb, 20);
    applyFlyOffset(orb, layout.orb);
    contentGroup.appendChild(orb);
  }

  if (layout.pathD) {
    const path = createSvgEl("path");
    path.setAttribute("d", layout.pathD);
    path.classList.add("scene-path");
    addDelay(path, 80);
    applyFlyOffset(path, {x: VIEWBOX_SIZE / 2, y: VIEWBOX_SIZE / 2});
    contentGroup.appendChild(path);
  }

  if (Array.isArray(layout.pills)) {
    layout.pills.forEach((pill, idx) => {
      const rect = createSvgEl("rect");
      rect.setAttribute("x", pill.x);
      rect.setAttribute("y", pill.y);
      rect.setAttribute("width", pill.width);
      rect.setAttribute("height", pill.height);
      rect.setAttribute("rx", 12);
      rect.classList.add("scene-pill");
      addDelay(rect, 120 + idx * 40);
      applyFlyOffset(rect, {x: pill.x + pill.width / 2, y: pill.y + pill.height / 2});
      contentGroup.appendChild(rect);
    });
  }

  if (Array.isArray(layout.pulses)) {
    layout.pulses.forEach((pulse, idx) => {
      const path = createSvgEl("path");
      path.setAttribute("d", pulse.d);
      path.classList.add("scene-pulse");
      addDelay(path, 160 + idx * 60);
      applyFlyOffset(path, {x: VIEWBOX_SIZE / 2, y: VIEWBOX_SIZE / 2});
      contentGroup.appendChild(path);
    });
  }

  if (Array.isArray(layout.assets)) {
    layout.assets.forEach((asset, idx) => {
      const wrapper = createSvgEl("g");
      addDelay(wrapper, asset.delay || idx * 80);
      if (asset.colorVar) {
        wrapper.style.setProperty("color", `var(${asset.colorVar})`);
      }
      // Per-asset float variation
      setFloatProps(wrapper);
      wrapper.classList.add("scene-asset");
      if (asset.className) {
        asset.className.split(" ").forEach((cls) => wrapper.classList.add(cls));
      }

      const graphic = createSvgEl("g");
      graphic.classList.add("scene-asset-graphic");

      let child = null;
      if (asset.icon) {
        child = createInlineAsset(asset);
      } else {
        const image = createSvgEl("image");
        image.setAttribute("width", asset.width);
        image.setAttribute("height", asset.height);
        image.setAttribute("href", asset.href);
        image.setAttribute("preserveAspectRatio", "xMidYMid meet");
        child = image;
      }

      if (!child) return;

      let tx = asset.x || 0;
      let ty = asset.y || 0;
      if (asset.center) {
        tx = VIEWBOX_SIZE / 2 - (asset.width || 0) / 2;
        ty = VIEWBOX_SIZE / 2 - (asset.height || 0) / 2;
      }

      graphic.setAttribute("transform", `translate(${tx} ${ty})`);

      // Position child at origin of its graphic group
      if (typeof child.setAttribute === "function") {
        if (!child.getAttribute("x")) child.setAttribute("x", 0);
        if (!child.getAttribute("y")) child.setAttribute("y", 0);
      }

      applyFlyOffset(wrapper, {x: tx + (asset.width || 0) / 2, y: ty + (asset.height || 0) / 2});

      graphic.appendChild(child);
      wrapper.appendChild(graphic);
      contentGroup.appendChild(wrapper);
    });
  }

  const groupAsset = layout.groupAsset;
  if (groupAsset && (groupAsset.src || typeof groupAsset === "string")) {
    const config = typeof groupAsset === "string" ? {src: groupAsset} : groupAsset;
    loadSvgGroupAsset(config.src).then((data) => {
      if (!data || destroyed) {
        markReady();
        return;
      }
      if (data.defs) {
        svg.insertBefore(data.defs.cloneNode(true), contentGroup);
      }
      const groups = data.groups || [];
      const baseDelay = config.startDelay ?? 60;
      const delayStep = config.delayStep ?? 70;
      groups.forEach((group, idx) => {
        const wrapper = createSvgEl("g");
        addDelay(wrapper, baseDelay + idx * delayStep);
        setFloatProps(wrapper, {
          amp: 3 + Math.random() * 6,
          ms: 2400 + Math.random() * 1400,
          driftX: (Math.random() - 0.5) * 10,
        });
        wrapper.classList.add("scene-asset");
        const clone = group.cloneNode(true);
        wrapper.appendChild(clone);
        contentGroup.appendChild(wrapper);
        const bbox = clone.getBBox ? clone.getBBox() : null;
        const gx = bbox ? bbox.x + bbox.width / 2 : VIEWBOX_SIZE / 2;
        const gy = bbox ? bbox.y + bbox.height / 2 : VIEWBOX_SIZE / 2;
        applyFlyOffset(wrapper, {x: gx, y: gy}, {magnitude: 0, jitter: 0, distScale: 0.9});
      });
      markReady();
    }).catch(() => {
      markReady();
    });
  } else {
    markReady();
  }

  if (Array.isArray(layout.metrics)) {
    layout.metrics.forEach((metric, idx) => {
      const g = createSvgEl("g");
      addDelay(g, metric.delay || 160 + idx * 60);
      g.classList.add("scene-metric");
      if (metric.colorVar) {
        g.style.setProperty("color", `var(${metric.colorVar})`);
      }
      const width = metric.width || 120;
      const height = metric.height || 52;
      g.setAttribute("transform", `translate(${metric.x || 0} ${metric.y || 0})`);
      applyFlyOffset(g, {x: (metric.x || 0) + width / 2, y: (metric.y || 0) + height / 2});

      const rect = createSvgEl("rect");
      rect.setAttribute("width", width);
      rect.setAttribute("height", height);
      rect.setAttribute("rx", Math.min(14, height / 2.2));
      rect.classList.add("scene-metric-rect");
      g.appendChild(rect);

      const label = createSvgEl("text");
      label.textContent = metric.label || "";
      label.setAttribute("x", width / 2);
      label.setAttribute("y", height / 2 - 4);
      label.classList.add("scene-metric-label");
      g.appendChild(label);

      const value = createSvgEl("text");
      value.textContent = metric.value || "";
      value.setAttribute("x", width / 2);
      value.setAttribute("y", height / 2 + 18);
      value.classList.add("scene-metric-value");
      g.appendChild(value);

      contentGroup.appendChild(g);
    });
  }

  svg.appendChild(contentGroup);

  const cleanup = () => {
    destroyed = true;
    markReady();
  };

  return {root: svg, maxDelay, ready, cleanup};
}

function createSceneManager(rootEl) {
  const ENTER_MS = 900;
  let activeScene = null;
  let enterTimer = null;

  function showScene(slideId) {
    if (!rootEl) return;
    if (enterTimer) {
      clearTimeout(enterTimer);
      enterTimer = null;
    }
    const layout = SCENE_LAYOUTS[slideId] || SCENE_LAYOUTS.splash;
    const next = createSceneFromLayout(layout);
    if (!next || !next.root) return;
    const enterStateClass = "welcome-scene--enter";
    const steadyStateClass = "welcome-scene--steady";

    const prev = activeScene;
    activeScene = next;

    const startEnter = () => {
      rootEl.appendChild(next.root);
      requestAnimationFrame(() => {
        next.root.classList.add(enterStateClass);
        const beginSteady = () => {
          const settleMs = ENTER_MS + (next.maxDelay || 0) + 160;
          setTimeout(() => {
            if (activeScene !== next) return;
            next.root.classList.remove(enterStateClass);
            next.root.classList.add(steadyStateClass);
          }, settleMs);
        };
        if (next.ready && typeof next.ready.then === "function") {
          next.ready.catch(() => {}).finally(beginSteady);
        } else {
          beginSteady();
        }
      });
    };

    if (prev && prev.root) {
      prev.root.classList.remove(enterStateClass, steadyStateClass);
      if (prev.root.parentNode === rootEl) {
        rootEl.removeChild(prev.root);
      }
      if (typeof prev.cleanup === "function") {
        prev.cleanup();
      }
      startEnter();
    } else {
      startEnter();
    }
  }

  return {
    showScene,
  };
}

export function initWelcomeTour(options = {}) {
  const {onFinished, onVisibilityChanged} = options;

  const overlay = document.getElementById("welcomeOverlay");
  const titleEl = document.getElementById("welcomeTitle");
  const bodyEl = document.getElementById("welcomeBody");
  const sceneEl = document.getElementById("welcomeScene");

  const prevBtn = document.getElementById("welcomePrevBtn");
  const nextBtn = document.getElementById("welcomeNextBtn");
  const closeBtn = document.getElementById("welcomeCloseBtn");
  const slideContainer = overlay
    ? overlay.querySelector(".welcome-slide")
    : null;

  if (
    !overlay ||
    !titleEl ||
    !bodyEl ||
    !sceneEl ||
    !slideContainer
  ) {
    console.warn("[Welcome] Required DOM elements not found; tour disabled.");
    return {
      open() {},
      close() {},
      goToSlide() {},
      playSplash() {},
    };
  }

  let currentIndex = 0;
  let isOpen = false;
  let isAnimating = false;
  let currentMode = "full"; // "full" | "splash"
  let autoCloseTimer = null;
  let splashTextTimer = null;
  let firstRenderDone = false;
  const sceneManager = createSceneManager(sceneEl);

  const visibilityCb =
    typeof onVisibilityChanged === "function" ? onVisibilityChanged : null;

  function notifyVisibility(isVisible) {
    if (visibilityCb) {
      visibilityCb({isOpen: isVisible, mode: currentMode});
    }
  }

  function clearAutoClose() {
    if (autoCloseTimer) {
      clearTimeout(autoCloseTimer);
      autoCloseTimer = null;
    }
  }

  function setOverlayMode(mode) {
    currentMode = mode === "splash" ? "splash" : "full";
    overlay.classList.toggle(
      "welcome-overlay--splash-only",
      currentMode === "splash"
    );
  }

  function computeBodyHtml(lines) {
    if (!lines || !lines.length) return "";
    return lines
      .map((line) => `<span class="welcome-body-line">${line}</span>`)
      .join("<br>");
  }

  function applySlideClasses(slide) {
    slideContainer.classList.toggle("welcome-slide--splash", slide.kind === "splash");
    slideContainer.classList.toggle(
      "welcome-slide--icon-only",
      slide.kind === "splash"
    );
  }

  function renderSlide(index) {
    const slide = SLIDES[index];
    if (!slide) return;

    currentIndex = index;

    titleEl.textContent = slide.title;

    bodyEl.innerHTML = computeBodyHtml(slide.bodyLines);

    applySlideClasses(slide);
    if (sceneManager) {
      sceneManager.showScene(slide.id);
    }

    if (splashTextTimer) {
      clearTimeout(splashTextTimer);
      splashTextTimer = null;
    }

    if (slide.id === "splash" && !firstRenderDone) {
      slideContainer.classList.remove("welcome-text-visible");
      slideContainer.classList.add("welcome-text-hidden");
      const navEls = [prevBtn, nextBtn, closeBtn].filter(Boolean);
      navEls.forEach((el) => el.classList.add("welcome-nav-hidden"));
      splashTextTimer = setTimeout(() => {
        slideContainer.classList.remove("welcome-text-hidden");
        slideContainer.classList.add("welcome-text-visible");
        navEls.forEach((el) => el.classList.remove("welcome-nav-hidden"));
      }, 1000);
    } else {
      slideContainer.classList.remove("welcome-text-hidden", "welcome-text-visible");
      [prevBtn, nextBtn, closeBtn].filter(Boolean).forEach((el) => {
        el.classList.remove("welcome-nav-hidden");
      });
    }

    if (prevBtn) {
      prevBtn.style.visibility = index === 0 ? "hidden" : "visible";
    }
    if (nextBtn) {
      nextBtn.style.visibility = "visible";
    }

    firstRenderDone = true;
  }

  function animateSlideChange(targetIndex, direction) {
    if (!slideContainer || targetIndex === currentIndex) {
      renderSlide(targetIndex);
      return;
    }
    if (isAnimating) return;

    isAnimating = true;
    const goingPrev = direction === "prev";
    const outClass = goingPrev
      ? "welcome-slide--animating-out-backward"
      : "welcome-slide--animating-out-forward";
    const inClass = goingPrev
      ? "welcome-slide--animating-in-backward"
      : "welcome-slide--animating-in-forward";

    // Animate out current slide first
    slideContainer.classList.remove(inClass, "welcome-slide--active");
    slideContainer.classList.add(outClass);

    const finishIn = () => {
      slideContainer.classList.remove(inClass, "welcome-slide--active");
      slideContainer.style.transform = "";
      slideContainer.style.opacity = "";
      isAnimating = false;
    };

    const startIn = () => {
      renderSlide(targetIndex);
      slideContainer.classList.remove(outClass, inClass, "welcome-slide--active");

      slideContainer.style.transition = "none";
      slideContainer.style.transform = goingPrev ? "translateX(-8%)" : "translateX(8%)";
      slideContainer.style.opacity = "0.1";
      // force reflow
      // eslint-disable-next-line no-unused-expressions
      slideContainer.offsetWidth;
      slideContainer.style.transition = "";
      slideContainer.classList.add(inClass);

      requestAnimationFrame(() => {
        slideContainer.classList.add("welcome-slide--active");
        slideContainer.style.transform = "translateX(0)";
        slideContainer.style.opacity = "1";
        const handleInEnd = (evt) => {
          if (evt && evt.target !== slideContainer) return;
          slideContainer.removeEventListener("transitionend", handleInEnd);
          finishIn();
        };
        slideContainer.addEventListener("transitionend", handleInEnd);
        setTimeout(finishIn, 330);
      });
    };

    const handleOutEnd = (evt) => {
      if (evt && evt.target !== slideContainer) return;
      slideContainer.removeEventListener("transitionend", handleOutEnd);
      startIn();
    };

    slideContainer.addEventListener("transitionend", handleOutEnd);
    setTimeout(handleOutEnd, 330);
  }

  function closeOverlay() {
    if (!isOpen) return;
    clearAutoClose();
    isOpen = false;
    const wasSplash = currentMode === "splash";
    overlay.classList.add("welcome-overlay--hiding");
    document.body.classList.remove("welcome-active");
    overlay.classList.remove("welcome-overlay--visible");

    let done = false;
    const finalize = () => {
      if (done) return;
      done = true;
      overlay.removeEventListener("transitionend", finalize);
      overlay.style.display = "none";
      overlay.classList.remove(
        "welcome-overlay--visible",
        "welcome-overlay--hiding"
      );
      if (!wasSplash) {
        overlay.classList.remove("welcome-overlay--splash-only");
      }
      notifyVisibility(false);
      if (typeof onFinished === "function") {
        onFinished();
      }
    };

    // Keep splash-only visuals until fully hidden to avoid caret flashing in splash mode.

    overlay.addEventListener("transitionend", finalize);
    window.setTimeout(finalize, 1000); // fallback if transitionend doesnâ€™t fire
  }

  function openOverlay(startIndex = 0, opts = {}) {
    if (isOpen) return;
    clearAutoClose();
    const {mode = "full", autoCloseMs = null} =
      opts && typeof opts === "object" ? opts : {};
    setOverlayMode(mode);
    isOpen = true;

    if (startIndex < 0 || startIndex >= SLIDES.length) {
      startIndex = 0;
    }

    renderSlide(startIndex);

    overlay.style.display = "flex";
    overlay.classList.remove("welcome-overlay--hiding");

    notifyVisibility(true);

    requestAnimationFrame(() => {
      overlay.classList.add("welcome-overlay--visible");
    });

    if (autoCloseMs) {
      autoCloseTimer = window.setTimeout(() => {
        closeOverlay();
      }, autoCloseMs);
    }
  }

  function goToNext() {
    if (currentMode === "splash") return;
    if (currentIndex >= SLIDES.length - 1) {
      closeOverlay();
      return;
    }
    const nextIndex = currentIndex + 1;
    animateSlideChange(nextIndex, "next");
  }

  function goToPrev() {
    if (currentMode === "splash") return;
    if (currentIndex <= 0) return;
    const prevIndex = currentIndex - 1;
    animateSlideChange(prevIndex, "prev");
  }

  function handleOverlayClick(event) {
    if (!isOpen) return;
    if (currentMode === "splash") {
      event.stopPropagation();
      return;
    }

    const target = event.target;

    // Ignore clicks on controls
    if (
      target.closest(".welcome-nav") ||
      target.closest(".welcome-close-btn")
    ) {
      return;
    }

    goToNext();
  }

  function handleKeydown(event) {
    if (!isOpen) return;
    if (event.metaKey || event.ctrlKey || event.altKey) return;
    event.stopPropagation();
    event.stopImmediatePropagation();

    const {key} = event;

    if (currentMode === "splash") {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
      if (key === "Escape") {
        closeOverlay();
      }
      return;
    }

    if (key === "Escape") {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
      closeOverlay();
    } else if (key === "ArrowRight" || key === "PageDown") {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
      goToNext();
    } else if (key === "ArrowLeft" || key === "PageUp") {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
      goToPrev();
    } else if (key === " " || key === "Enter") {
      const active = document.activeElement;
      if (active === overlay || active === document.body) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        goToNext();
      }
    }
  }

  overlay.addEventListener("click", handleOverlayClick);

  if (prevBtn) {
    prevBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      goToPrev();
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      goToNext();
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      closeOverlay();
    });
  }

  document.addEventListener("keydown", handleKeydown);

  return {
    open: openOverlay,
    close: closeOverlay,
    playSplash(durationMs = 2000) {
      openOverlay(0, {mode: "splash", autoCloseMs: durationMs});
    },
    goToSlide(index) {
      if (index < 0 || index >= SLIDES.length) return;
      if (!isOpen) {
        openOverlay(index);
      } else {
        const dir = index > currentIndex ? "next" : "prev";
        animateSlideChange(index, dir);
      }
    },
  };
}
