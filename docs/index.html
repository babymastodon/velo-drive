<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VeloDrive</title>

    <!-- SVG primary favicon -->
    <link rel="icon" type="image/svg+xml" href="icons/logo_sq.svg" />

    <!-- PNG fallbacks -->
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon32.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="icons/icon48.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="128x128"
      href="icons/icon128.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="icons/icon192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="icons/icon512.png"
    />

    <!-- PWA Manifest -->
    <link rel="manifest" href="velodrive.webmanifest" />

    <!-- Dynamic theme colors -->
    <meta
      name="theme-color"
      content="#f4f4f4"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#222222"
      media="(prefers-color-scheme: dark)"
    />

    <script src="theme-init.js"></script>

    <link rel="stylesheet" href="workout-base.css" />
    <link rel="stylesheet" href="workout-planner.css" />
    <link rel="stylesheet" href="workout-picker.css" />
    <link rel="stylesheet" href="settings.css" />
    <link rel="stylesheet" href="welcome.css" />
  </head>

  <body class="welcome-active">
    <!-- Welcome / first-run tour overlay (placed first to avoid flash of content) -->
    <div
      id="welcomeOverlay"
      class="welcome-overlay"
      aria-modal="true"
      role="dialog"
      aria-label="Welcome intro"
    >
      <div class="welcome-shell">
        <button
          id="welcomeCloseBtn"
          class="welcome-close-btn"
          type="button"
          aria-label="Skip intro"
        >
          ×
        </button>

        <div
          class="welcome-slide welcome-slide--splash welcome-slide--icon-only welcome-text-hidden"
        >
          <header class="welcome-header">
            <h1 id="welcomeTitle" class="welcome-title"></h1>
          </header>

          <main class="welcome-main">
            <div class="welcome-scene-wrapper">
              <div
                id="welcomeScene"
                class="welcome-scene"
                aria-hidden="true"
              ></div>
            </div>
          </main>

          <p id="welcomeBody" class="welcome-body"></p>
        </div>

        <button
          id="welcomePrevBtn"
          class="welcome-nav welcome-nav-prev"
          type="button"
          aria-label="Previous"
        >
          <span>❮</span>
        </button>

        <button
          id="welcomeNextBtn"
          class="welcome-nav welcome-nav-next"
          type="button"
          aria-label="Next"
        >
          <span>❯</span>
        </button>
      </div>
    </div>

    <div class="page-root">
      <section class="top-panel" aria-label="Workout stats">
        <div class="stat-card" data-key="power">
          <div class="stat-label">Power</div>
          <div class="stat-value"><span id="stat-power">--</span></div>
        </div>
        <div class="stat-card" data-key="intervalTime">
          <div class="stat-label">Interval Time</div>
          <div class="stat-value stat-lg">
            <span id="stat-interval-time">00:00</span>
          </div>
        </div>
        <div class="stat-card" data-key="heartRate">
          <div class="stat-label">Heart Rate</div>
          <div class="stat-value"><span id="stat-hr">--</span></div>
        </div>
        <div class="stat-card" data-key="targetPower">
          <div class="stat-label">Target Power</div>
          <div class="stat-value"><span id="stat-target-power">--</span></div>
        </div>
        <div class="stat-card" data-key="elapsedTime">
          <div class="stat-label">Workout Time</div>
          <div class="stat-value stat-lg">
            <span id="stat-elapsed-time">00:00:00</span>
          </div>
        </div>
        <div class="stat-card" data-key="cadence">
          <div class="stat-label">Cadence</div>
          <div class="stat-value"><span id="stat-cadence">--</span></div>
        </div>
      </section>

      <section
        id="chartPanel"
        class="chart-panel"
        aria-label="Workout profile and live data"
      >
        <div
          id="chartEmptyOverlay"
          class="chart-empty-state"
          style="display: none"
        >
          <div id="chartEmptyMessage" class="chart-empty-message">
            Connect your bike
          </div>

          <!-- Single arrow SVG; JS just flips it left/right -->
          <svg
            id="chartEmptyArrow"
            class="chart-empty-arrow chart-empty-arrow--left"
            viewBox="0 0 52.916665 52.916666"
            preserveAspectRatio="none"
            aria-hidden="true"
          >
            <g>
              <path
                class="chart-empty-arrow-main"
                d="M 51.472993,14.207927
         C 46.120999,17.671066 40.269075,17.583209 34.622628,17.157855
           29.288422,16.788704 23.874176,16.262741 18.609072,18.089194
           14.872863,19.770591 12.035953,24.626821 9.8229085,29.694766
           7.5506784,35.257104 6.0236691,40.53837 4.6810022,46.394288"
              />

              <path
                class="chart-empty-arrow-main"
                d="m 2.9466055,41.671853
         c 0.066234,0.595617 0.2291127,1.842722 0.2430367,2.548134
           0.1721301,1.129681 -0.047682,2.299663 0.8821012,3.521698
           1.0543304,-0.189198 1.9004822,-1.093461 2.8846226,-1.547496
           0.804207,-0.437777 0.8540386,-0.58115 1.6908182,-0.913426"
              />
            </g>
          </svg>
        </div>

        <svg
          id="chartSvg"
          viewBox="0 0 1000 400"
          preserveAspectRatio="none"
        ></svg>
        <div id="chartTooltip" class="chart-tooltip"></div>
      </section>
    </div>

    <!-- Bottom nav -->
    <nav class="bottom-nav">
      <div class="nav-left">
        <!-- Bike / trainer status -->
        <button class="device-group" id="bikeConnectBtn">
          <div class="icon-box">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M5 16.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zm0 0 3-6h4l3 6m-4-6 1.5-3M16 7h-3m7 9.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"
              />
            </svg>
            <div id="bikeStatusDot" class="status-dot"></div>
          </div>
          <div class="device-label">
            <span>Bike</span>
          </div>
        </button>

        <!-- HR status -->
        <button class="device-group" id="hrConnectBtn">
          <div class="icon-box">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M12 20s-4.5-2.9-7-6.1C3.2 12.1 3 10.8 3 9.9 3 7.8 4.7 6 6.9 6c1.3 0 2.6.6 3.4 1.8C11.5 6.6 12.8 6 14.1 6 16.3 6 18 7.8 18 9.9c0 .9-.2 2.2-2 4-2.5 3.2-7 6.1-7 6.1z"
              />
            </svg>
            <div id="hrStatusDot" class="status-dot"></div>
          </div>
          <div class="device-label">
            <span>HRM</span>
            <span id="hrBatteryLabel" class="device-battery"></span>
          </div>
        </button>

        <!-- Settings (immediately right of HR) -->
        <button id="settingsBtn" class="nav-icon-button" title="Settings (S)">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.61-.22l-2.39.96a7.007 7.007 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 14.5 2h-4a.5.5 0 0 0-.49.42l-.36 2.54c-.59.24-1.13.55-1.63.94l-2.39-.96a.5.5 0 0 0-.61.22L3.1 8.84a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.65-.06.94 0 .32.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.43.34.68.24l2.39-.96c.5.39 1.04.7 1.63.94l.36 2.54c.05.24.25.42.49.42h4c.24 0 .44-.18.49-.42l.36-2.54c.59-.24 1.13-.55 1.63-.94l2.39.96c.25.1.54 0 .68-.24l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"
            />
          </svg>
        </button>

        <button
          id="calendarBtn"
          class="playback-button calendar-button"
          title="Open calendar (C)"
        >
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M 7,3 V 6 M 17,3 v 3" />
            <rect x="4" y="6" width="16" height="14" rx="2" />
            <path d="M 4,10 H 20" />
          </svg>
        </button>
      </div>

      <div class="workout-title-wrapper">
        <div
          id="workoutTitleCenter"
          class="workout-title-center"
          style="display: none"
          title=""
        >
          <!-- text filled by JS -->
        </div>
      </div>

      <div class="nav-right">
        <!-- Workout controls: FTP + title + playback -->
        <div id="workoutControls" class="workout-controls">
          <div id="modeToggle" class="mode-toggle" title="Free ride control mode">
            <button
              class="mode-toggle-button active"
              data-mode="erg"
              title="Change to ERG (E)"
            >
              ERG
            </button>
            <button
              class="mode-toggle-button"
              data-mode="resistance"
              title="Change to resistance (R)"
            >
              Resistance
            </button>
          </div>

          <!-- Manual controls for ERG / Resistance -->
          <div id="manualControls" class="control-group" style="display: none">
            <button class="control-btn" data-delta="-10">-</button>
            <div class="control-value">
              <!-- Reuse the FTP input styling -->
              <input
                id="manualInput"
                class="settings-ftp-input"
                type="number"
                inputmode="numeric"
              />
              <span id="manualUnit" class="settings-ftp-unit"></span>
            </div>
            <button class="control-btn" data-delta="10">+</button>
          </div>

          <div id="workoutNameLabel" class="inline-clicktoggle">
            Selected workout
          </div>

          <!-- START button -->
          <button
            id="startBtn"
            class="playback-button"
            title="Start workout (Space)"
          >
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M9 7v10l8-5z" />
            </svg>
          </button>

          <!-- PLAY button (for resume) -->
          <button id="playBtn" class="playback-button" title="Resume workout">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M9 7v10l8-5z" />
            </svg>
          </button>

          <!-- PAUSE button -->
          <button id="pauseBtn" class="playback-button" title="Pause workout">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M9 7v10M15 7v10" />
            </svg>
          </button>

          <!-- STOP button -->
          <button id="stopBtn" class="playback-button" title="End workout">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <rect x="8" y="8" width="8" height="8" />
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <!-- Workout picker overlay -->
    <div
      id="workoutPickerOverlay"
      class="workout-picker-overlay"
      aria-modal="true"
      role="dialog"
    >
      <div id="workoutPickerModal" class="workout-picker-modal">
        <header class="workout-picker-header picker-only">
          <div class="workout-picker-header-actions">
            <button
              id="pickerBackToPlannerBtn"
              class="wb-code-insert-btn picker-back-btn"
              type="button"
              style="display: none"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="wb-code-icon">
                <path
                  d="M15 6l-6 6 6 6"
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Back to calendar</span>
            </button>

            <button
              id="workoutBuilderBackBtn"
              class="wb-code-insert-btn picker-back-btn"
              type="button"
              style="display: none"
            >
              <svg
                viewBox="0 0 24 24"
                aria-hidden="true"
                style="
                  width: 16px;
                  height: 16px;
                  display: block;
                  stroke-width: 1.6;
                "
                class="wb-code-icon"
              >
                <path
                  d="M15 6l-6 6 6 6"
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Back To Library</span>
            </button>
          </div>

          <div class="workout-picker-header-main">
            <div class="workout-picker-title" id="workoutPickerTitle">
              Workout library
            </div>
          </div>

          <div class="workout-picker-controls">
            <div class="picker-search-wrap">
              <svg
                viewBox="0 0 24 24"
                class="picker-search-icon"
                aria-hidden="true"
              >
                <circle
                  cx="11"
                  cy="11"
                  r="7"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <line
                  x1="16"
                  y1="16"
                  x2="21"
                  y2="21"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <input
                id="pickerSearchInput"
                type="search"
                placeholder="eg. tempo 60-90 min"
              />
              <button
                type="button"
                class="picker-search-clear"
                aria-label="Clear search"
                title="Clear search"
              >
                <svg viewBox="0 0 12 12" aria-hidden="true">
                  <path
                    d="M2 2l8 8M10 2L2 10"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                  />
                </svg>
              </button>
            </div>
            <select id="pickerZoneFilter">
              <option value="">All zones</option>
              <option value="Recovery">Recovery</option>
              <option value="Endurance">Endurance</option>
              <option value="Tempo">Tempo</option>
              <option value="Threshold">Threshold</option>
              <option value="VO2Max">VO2Max</option>
              <option value="HIIT">HIIT</option>
            </select>
            <select id="pickerDurationFilter">
              <option value="">All durations</option>
              <option value="1-30">1–30 min</option>
              <option value="31-60">31–60 min</option>
              <option value="61-90">61–90 min</option>
              <option value="91-120">91–120 min</option>
              <option value="121-150">121–150 min</option>
              <option value="151-180">151–180 min</option>
              <option value="181-210">181–210 min</option>
              <option value="211-240">211–240 min</option>
              <option value=">240">&gt; 4 hours</option>
            </select>

            <button
              id="pickerAddWorkoutBtn"
              class="picker-add-btn"
              type="button"
            >
              <svg viewBox="0 0 24 24" class="wb-code-icon" aria-hidden="true">
                <path
                  d="M12 5v14M5 12h14"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <span>Create workout</span>
            </button>

            <div
              id="workoutBuilderStatus"
              class="builder-status"
              style="display: none"
            ></div>

            <button
              id="workoutBuilderTrainerDayBtn"
              class="wb-code-insert-btn"
              type="button"
              style="display: none"
              title="Load a TrainerDay workout by URL"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="wb-code-icon">
                <path
                  d="M18 3h3v3"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M21 3l-9 9"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Import TrainerDay</span>
            </button>

            <button
              id="workoutBuilderUploadBtn"
              class="wb-code-insert-btn"
              type="button"
              style="display: none"
              title="Upload a .zwo or .fit file"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="wb-code-icon">
                <path
                  d="M12 16V5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M8 9l4-4 4 4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M5 19h14"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <span>Upload File</span>
            </button>

            <button
              id="workoutBuilderSaveBtn"
              class="picker-add-btn picker-save-btn"
              type="button"
              style="display: none"
              title="Save workout to library"
            >
              <svg
                viewBox="0 0 24 24"
                aria-hidden="true"
                style="width: 16px; height: 16px; display: block"
                class="wb-code-icon"
              >
                <!-- Modern floppy disk style using only currentColor -->
                <path
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linejoin="round"
                  d="M4 3h13l3 3v15H4z"
                />
                <path
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linejoin="round"
                  d="M8 3v6h8V3"
                />
                <rect
                  x="7"
                  y="15"
                  width="10"
                  height="5"
                  rx="1"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                />
              </svg>

              <span>Save</span>
            </button>

            <button
              id="workoutPickerCloseBtn"
              class="picker-close-btn"
              title="Close"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" />
              </svg>
            </button>
          </div>
        </header>

        <div
          id="workoutBuilderRoot"
          class="workout-builder-root picker-only"
          style="display: none"
        ></div>

        <div class="workout-picker-table-wrapper picker-only">
          <div
            id="pickerEmptyState"
            class="picker-empty-state"
            style="display: none"
          >
            <div class="picker-empty-message">
              No workouts found. Add your first workout.
            </div>
            <button
              id="pickerEmptyAddBtn"
              type="button"
              class="picker-empty-add-btn"
            >
              + Add workout
            </button>
          </div>

          <table class="workout-picker-table">
            <thead>
              <tr>
                <th data-sort-key="name" title="Workout name">Name</th>
                <th title="Primary intensity focus (same colors as workout history)">Zone</th>
                <th title="Where the workout came from (file name, scraper, or source)">Source</th>
                <th
                  data-sort-key="if"
                  title="Intensity Factor: normalized power divided by FTP; 1.0 means riding steadily at FTP"
                >
                  IF
                </th>
                <th
                  data-sort-key="tss"
                  title="Training Stress Score: 100 equals 1 hour at FTP; typical weeks are ~300-700"
                >
                  TSS
                </th>
                <th
                  data-sort-key="duration"
                  title="Planned moving time; paused time is not counted"
                >
                  Duration
                </th>
                <th
                  data-sort-key="kjAdj"
                  title="Estimated work (kJ) at your FTP; roughly equals Calories if power is accurate"
                >
                  kJ
                </th>
              </tr>
            </thead>
            <tbody id="pickerWorkoutTbody">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <div class="picker-footer picker-only picker-footer-library">
          <span>
            <strong>j k</strong> or <strong>↑ ↓</strong> to move &bull;
            <strong>Enter</strong> to select workout &bull;
            <strong>/</strong> to search
          </span>
          <span id="pickerSummary" class="workout-picker-summary"></span>
        </div>
        <div
          id="builderFooter"
          class="picker-footer picker-only picker-footer-builder"
        >
          <span id="builderShortcuts"></span>
        </div>

        <header class="workout-planner-header planner-only">
          <div class="workout-planner-left">
            <button
              id="plannerBackBtn"
              class="wb-code-insert-btn picker-back-btn planner-back-btn"
              type="button"
              style="display: none"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="wb-code-icon">
                <path
                  d="M15 6l-6 6 6 6"
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Back to calendar</span>
            </button>
            <div class="workout-planner-title"></div>
          </div>
          <div
            id="plannerSelectedDateLabel"
            class="workout-planner-selected"
            aria-live="polite"
          ></div>
          <div class="workout-planner-actions workout-picker-controls">
            <button
              id="plannerDeleteBtn"
              class="wb-code-insert-btn delete-workout-btn"
              type="button"
              style="display: none"
              title="Delete workout"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="wb-code-icon">
                <path
                  d="M21 6H3"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="M10 11v6M14 11v6"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <span>Delete</span>
            </button>
            <button
              id="plannerScheduleBtn"
              class="picker-add-btn planner-schedule-btn"
              type="button"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="wb-code-icon">
                <path
                  d="M12 5v14M5 12h14"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Schedule workout</span>
            </button>
            <button
              id="workoutPlannerCloseBtn"
              class="picker-close-btn"
              title="Close calendar"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" />
              </svg>
            </button>
          </div>
        </header>

        <div class="workout-planner-body planner-only">
          <div class="planner-calendar">
            <div class="planner-calendar-header" id="plannerCalendarHeader">
              <div class="planner-day-head">Sun</div>
              <div class="planner-day-head">Mon</div>
              <div class="planner-day-head">Tue</div>
              <div class="planner-day-head">Wed</div>
              <div class="planner-day-head">Thu</div>
              <div class="planner-day-head">Fri</div>
              <div class="planner-day-head">Sat</div>
            </div>
            <div class="planner-calendar-body" id="plannerCalendarBody">
              <!-- rows injected by JS -->
            </div>
          </div>

          <div
            class="planner-detail-view"
            id="plannerDetailView"
            style="display: none"
          >
            <div class="planner-detail-top">
              <div class="planner-detail-stats" id="plannerDetailStats"></div>
              <div class="planner-detail-curve">
                <div class="planner-curve-title-row">
                  <div class="planner-curve-title">Power curve</div>
                  <div
                    class="planner-curve-help"
                    role="img"
                    aria-label="What the power curve means"
                    title="Shows the strongest average power you held for every duration in this ride; use it to compare peaks across rides, spot fades at longer efforts, and set pacing targets."
                  >
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <circle
                        cx="12"
                        cy="12"
                        r="9"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.6"
                      ></circle>
                      <path
                        d="M9.5 9a2.5 2.5 0 1 1 3.2 2.4c-.9.3-1.2.8-1.2 1.6V14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      ></path>
                      <circle cx="12" cy="17" r="1.2" fill="currentColor"></circle>
                    </svg>
                  </div>
                </div>
                <svg
                  id="plannerPowerCurveSvg"
                  class="planner-power-curve"
                  viewBox="0 0 600 300"
                ></svg>
              </div>
            </div>
            <div
              class="planner-detail-chart-panel"
              id="plannerDetailChartPanel"
            >
              <svg
                id="plannerDetailChartSvg"
                class="planner-detail-chart"
                viewBox="0 0 1000 320"
                preserveAspectRatio="none"
              ></svg>
              <div id="plannerDetailChartTooltip" class="chart-tooltip"></div>
            </div>
          </div>

          <div class="planner-footer" id="plannerFooter">
            <div class="planner-footer-left">
              <span id="plannerHotkeyPrompt"
                >Press <strong>?</strong> for shortcuts</span
              >
              <span id="plannerHotkeyList" style="display: none">
                <strong>↑↓←→</strong> or <strong>hjkl</strong> to move •
                <strong>Enter</strong> to open • <strong>e</strong> to edit •
                <strong>d</strong> or <strong>Delete</strong> to delete • drag
                and drop to reschedule
              </span>
            </div>
            <div class="planner-footer-right">
              <span id="plannerAgg3"></span>
              <span class="planner-footer-sep">·</span>
              <span id="plannerAgg7"></span>
              <span class="planner-footer-sep">·</span>
              <span id="plannerAgg30"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings overlay -->
    <div
      id="settingsOverlay"
      class="settings-overlay"
      aria-modal="true"
      role="dialog"
    >
      <div id="settingsModal" class="settings-modal" tabindex="-1">
        <header class="settings-header">
          <div class="settings-header-actions">
            <button
              id="settingsBackFromLogsBtn"
              class="settings-button"
              type="button"
              style="display: none"
            >
              <svg
                viewBox="0 0 24 24"
                aria-hidden="true"
                style="
                  width: 18px;
                  height: 18px;
                  display: block;
                  stroke-width: 1.8;
                "
              >
                <path
                  d="M15 6l-6 6 6 6"
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span>Back to settings</span>
            </button>
          </div>

          <div class="settings-header-main">
            <div id="settingsTitle" class="settings-title">Settings</div>
          </div>

          <div class="settings-header-actions">
            <button
              id="settingsCloseBtn"
              class="settings-close-btn"
              title="Close settings"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" />
              </svg>
            </button>
          </div>
        </header>

        <div class="settings-body">
          <!-- Main settings view -->
          <div id="settingsMainView" class="settings-main-view">
            <div
              id="settingsCompatibilityAlert"
              class="settings-alert settings-alert-warning"
              hidden
            >
              <div id="settingsCompatibilityText"></div>
            </div>

            <div class="settings-list">
              <div class="settings-row">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M4 5h6l2 2h8v12H4z" />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">
                      VeloDrive folder
                      <button
                        class="settings-help-toggle-btn"
                        type="button"
                        data-settings-help-toggle="settingsFoldersHelp"
                      >
                        Help
                      </button>
                    </div>
                    <div class="settings-row-description">
                      Workouts, history, and trash live in one folder you pick.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <div class="settings-inline-group">
                    <div class="settings-row-status" id="rootDirStatus"></div>
                    <button
                      id="rootDirButton"
                      class="settings-button"
                      type="button"
                    >
                      Choose…
                    </button>
                  </div>
                </div>
              </div>

              <div
                id="settingsFoldersHelp"
                class="settings-help-content"
                hidden
              >
                Pick a home base for VeloDrive (for example
                <code>~/Dropbox/VeloDrive</code>). We’ll use that one spot to
                store everything and you can reselect it later if you move
                devices.
              </div>

              <div class="settings-row">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M11 21L5 13h4V3l8 8h-4v10z" />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">
                      FTP
                      <button
                        class="settings-help-toggle-btn"
                        type="button"
                        data-settings-help-toggle="settingsFtpHelp"
                      >
                        What’s this?
                      </button>
                    </div>
                    <div class="settings-row-description">
                      Tweak difficulty if workouts feel too easy or hard.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <div id="settingsFtpControls" class="control-group">
                    <button
                      class="control-btn"
                      type="button"
                      data-ftp-delta="-10"
                    >
                      -
                    </button>
                    <div class="control-value">
                      <input
                        id="settingsFtpInput"
                        class="settings-ftp-input"
                        type="number"
                        min="50"
                        max="500"
                        step="1"
                        inputmode="numeric"
                      />
                      <span class="settings-ftp-unit">W</span>
                    </div>
                    <button
                      class="control-btn"
                      type="button"
                      data-ftp-delta="10"
                    >
                      +
                    </button>
                  </div>
                </div>
              </div>

              <div id="settingsFtpHelp" class="settings-help-content" hidden>
                FTP is the power you can hold for about an hour. If you do not
                know it, multiply your weight in kg by 3 for a quick starting
                point.
              </div>

              <div class="settings-row" id="settingsSoundToggle">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M5 10v4h3l4 4V6l-4 4H5z" />
                      <path
                        d="M15 9.5c1 .7 1.6 1.9 1.6 3.1 0 1.2-.6 2.4-1.6 3.1"
                      />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">
                      Sounds
                      <button
                        class="settings-help-toggle-btn"
                        type="button"
                        data-settings-help-toggle="settingsSoundHelp"
                      >
                        What will I hear?
                      </button>
                    </div>
                    <div class="settings-row-description">
                      Interval beeps and the start countdown.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <label class="settings-toggle-switch">
                    <input id="settingsSoundCheckbox" type="checkbox" />
                    <span class="settings-toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div id="settingsSoundHelp" class="settings-help-content" hidden>
                A short beep before interval changes, a stronger cue before big
                efforts, and a quick countdown when you hit start.
              </div>

              <div class="settings-row">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="12" r="4" />
                      <path d="M12 2.5v2" />
                      <path d="M12 19.5v2" />
                      <path d="M4.5 12h-2" />
                      <path d="M21.5 12h-2" />
                      <path d="m5.6 5.6-1.4-1.4" />
                      <path d="m19.8 19.8-1.4-1.4" />
                      <path d="m5.6 18.4-1.4 1.4" />
                      <path d="m19.8 4.2-1.4 1.4" />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">Theme</div>
                    <div class="settings-row-description">
                      Choose light, dark, or follow your system.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <div
                    id="settingsThemeToggle"
                    class="mode-toggle"
                    role="group"
                    aria-label="Theme"
                  >
                    <button
                      class="mode-toggle-button"
                      type="button"
                      data-theme-mode="auto"
                    >
                      Auto
                    </button>
                    <button
                      class="mode-toggle-button"
                      type="button"
                      data-theme-mode="dark"
                    >
                      Dark
                    </button>
                    <button
                      class="mode-toggle-button"
                      type="button"
                      data-theme-mode="light"
                    >
                      Light
                    </button>
                  </div>
                </div>
              </div>

              <div class="settings-row">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 3v18l5-5-3.5-4L17 8l-5-5z" />
                      <path d="M7 8l5 4-5 4" />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">
                      Bluetooth
                      <button
                        class="settings-help-toggle-btn"
                        type="button"
                        data-settings-help-toggle="settingsEnvHelp"
                      >
                        Details
                      </button>
                    </div>
                    <div class="settings-row-description">
                      Web Bluetooth support for trainer and HR pairing.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <div
                    id="settingsBtStatusText"
                    class="settings-row-status"
                  ></div>
                </div>
              </div>

              <div id="settingsEnvHelp" class="settings-help-content" hidden>
                Web Bluetooth is supported only in Google Chrome. If devices
                will not show up, copy/paste these URLs into Chrome's address
                bar, set them to <b>Enabled</b>, restart, and try again:
                <ul style="margin: 6px 0 0 18px; padding-left: 0">
                  <li><code>chrome://flags/#enable-web-bluetooth</code></li>
                  <li>
                    <code
                      >chrome://flags/#enable-web-bluetooth-new-permissions-backend</code
                    >
                  </li>
                </ul>
              </div>

              <div class="settings-row">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path
                        d="M9.453 20.134h5.253M12.428 4.786H3.234v12.815h17.511v-3.343M20.586 9.244l-3.104 3.104-3.104-3.104m3.104-4.298v7.403"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.6"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">
                      Offline Mode (PWA)
                      <button
                        class="settings-help-toggle-btn"
                        type="button"
                        data-settings-help-toggle="settingsPwaHelp"
                      >
                        How do I install it?
                      </button>
                    </div>
                    <div class="settings-row-description">
                      Install the Progressive Web App for offline workouts.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <div
                    id="settingsPwaStatusText"
                    class="settings-row-status"
                  ></div>
                </div>
              </div>

              <div id="settingsPwaHelp" class="settings-help-content" hidden>
                In Chrome on desktop, click the install icon in the address bar
                on the right side → <strong>Install VeloDrive</strong>. On
                Android, open Chrome’s menu and select
                <strong>Add to Home screen</strong>. If you’re using the Chrome
                extension, you’re already set.
              </div>

              <div class="settings-row">
                <div class="settings-row-main">
                  <div class="settings-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M5 5h14M5 9h10M5 13h14M5 17h8" />
                    </svg>
                  </div>
                  <div class="settings-row-text">
                    <div class="settings-row-label">Connection logs</div>
                    <div class="settings-row-description">
                      Live Bluetooth and device messages.
                    </div>
                  </div>
                </div>
                <div class="settings-row-right">
                  <button
                    id="settingsOpenLogsBtn"
                    class="settings-button"
                    type="button"
                  >
                    View logs
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs view -->
          <div id="settingsLogsView" class="settings-logs-view">
            <div id="settingsLogsContent" class="settings-logs-body"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status overlay (3-2-1 / paused / resumed) -->
    <div id="statusOverlay" class="status-overlay">
      <div id="statusText"></div>
    </div>

    <script type="module" src="workout.js"></script>
  </body>
</html>
